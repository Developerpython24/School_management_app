{% extends "base.html" %}
{% block content %}
<h2>چارت گزارش {% if report_type == 'individual' %}{{ student.first_name }} {{ student.last_name }}{% else %}{{ class_obj.name if class_obj else 'کلاس' }}{% endif %}</h2>
<canvas id="chart" width="400" height="200"></canvas>
{% if report_type == 'individual' %}
<script>
    const ctx = document.getElementById('chart').getContext('2d');
    const labels = {{ scores | map(attribute='date') | map('strftime', '%Y-%m-%d') | list | tojson }};
    const data = {{ scores | map(attribute='score') | list | tojson }};
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'نمرات',
                data: data,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% elif report_type == 'class' %}
<script>
    const ctx = document.getElementById('chart').getContext('2d');
    const labels = {{ students | map(attribute='first_name') | list | tojson }};
    const data = [{% for student in students %}
        {{ (student.scores | map(attribute='score') | sum / (student.scores | length) if student.scores and (student.scores | length > 0) else 0) | round(2) }}{% if not loop.last %}, {% endif %}
    {% endfor %}];
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'میانگین نمرات',
                data: data,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
{% else %}
<p>نوع گزارش نامعتبر است.</p>
{% endif %}
{% endblock %}